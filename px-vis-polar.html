<!--
    Relative paths assume component is being run from inside an app or another component, where dependencies are flat
    siblings. When this component is run from its own repo (e.g. tests, examples), we assume the server is started with
    'gulp serve' (or similar server setup) to enable correct finding of bower dependencies for local runs.
-->
<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../px-vis/px-vis-behavior-chart.html"/>
<link rel="import" href="../px-vis/px-vis-behavior-common.html"/>
<link rel="import" href="../px-vis/px-vis-behavior-d3.html"/>
<link rel="import" href="../px-vis/px-vis-radial-scale.html"/>
<link rel="import" href="../px-vis/px-vis-svg.html"/>
<link rel="import" href="../px-vis/px-vis-scatter.html"/>
<link rel="import" href="../px-vis/px-vis-line.html"/>
<link rel="import" href="../px-vis/px-vis-axis.html"/>
<link rel="import" href="../px-vis/px-vis-tooltip.html"/>
<link rel="import" href="../px-vis/px-vis-interaction-space.html"/>
<link rel="import" href="../px-vis/px-vis-register.html"/>
<link rel="import" href="../px-vis/px-vis-zoom.html"/>
<link rel="import" href="../px-vis/px-vis-cursor.html"/>
<link rel="import" href="../px-vis/px-vis-clip-path.html"/>
<link rel="import" href="../px-vis/px-vis-radial-gridlines.html"/>
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html" />

<link rel="import" href="css/px-vis-polar-styles.html">

<!--
REPLACE THIS TEXT WITH A COMPONENT DESCRIPTION

##### Usage

    <px-vis-polar counter-value="1"><a href="javascript:" on-click="handleClick">Click here to increment counter:</a><span>{{counterValue}}</span></px-vis-polar>

@element px-vis-polar
@blurb REPLACE THIS TEXT WITH A COMPONENT DESCRIPTION
@homepage index.html
@demo index.html
-->

<dom-module id="px-vis-polar">
  <template>
    <style include="px-vis-polar-styles"></style>
    <style include="px-theme-styles"></style>

    <div id="wrapper" class="wrapper">
      <!-- Legend -->
      <div class$="{{_getWrapperClass(_registerType)}}">

        <!--<px-vis-register
          id="register"
          class$="{{_getHideClass(hideRegister)}}"
          tooltip-data="[[tooltipData]]"
          chart-data="[[_filteredData]]"
          complete-series-config="[[completeSeriesConfig]]"
          muted-series={{mutedSeries}}
          type="{{_registerType}}"
          x-axis-type="[[xAxisType]]"
          y-axis-type="[[yAxisType]]">
        </px-vis-register>-->

        <div id="svgWrapper">
          <!-- Core -->
          <px-vis-radial-scale
            id="scale"
            width="[[_radius]]"
            height="[[_radius]]"
            margin="[[margin]]"
            chart-data="[[chartData]]"
            x="{{x}}"
            y="{{y}}"
            domain-changed="{{domainChanged}}"
            current-domain-x="{{currentDomainX}}"
            current-domain-y="{{currentDomainY}}"
            selected-domain="[[selectedDomain]]"
            chart-extents="[[chartExtents]]"
            complete-series-config="[[completeSeriesConfig]]"
            amplitude-keys="[[amplitudeKey]]">
          </px-vis-radial-scale>
          <px-vis-svg
            class="inline--flex"
            id="svg"
            width="[[width]]"
            height="[[height]]"
            margin="[[margin]]"
            svg="{{svg}}"
            px-svg-elem="{{pxSvgElem}}"
            offset="[[_center]]">
          </px-vis-svg>
          
          <!-- scatter series -->
          <template is="dom-repeat" items="[[_returnKeys(completeSeriesConfig)]]">
            <px-vis-scatter
              svg="[[_drawingSvg]]"
              series-id="[[item]]"
              chart-data="[[_filteredData]]"
              radial
              counter-clockwise="[[counterClockwise]]"
              use-degrees="[[useDegrees]]"
              x="[[x]]"
              y="[[y]]"
              domain-changed="[[domainChanged]]"
              muted-series="[[mutedSeries]]"
              complete-series-config="[[completeSeriesConfig]]"
              tooltip-data="{{tooltipData}}"
              tooltip-on-hover
              time-data="{{timeData}}"
              >
            </px-vis-scatter>
            <px-vis-line
              svg="[[_drawingSvg]]"
              radial-line
              counter-clockwise="[[counterClockwise]]"
              use-degrees="[[useDegrees]]"
              series-id="[[item]]"
              chart-data="[[_filteredData]]"
              muted-series="[[mutedSeries]]"
              x="[[x]]"
              y="[[y]]"
              domain-changed="[[domainChanged]]"
              complete-series-config="[[completeSeriesConfig]]">
            </px-vis-line>
          </template>
        </div>
      </div>
      <!-- the 4 axis -->
      <template is="dom-repeat" items="[[_axisConfigArray]]">
        <px-vis-axis
        svg="[[svg]]"
        axis="[[y]]"
        height="[[item.height]]"
        width="[[item.width]]"
        title="[[item.title]]"
        title-location="[[item.titleLocation]]"
        rotation="[[item.rotation]]"
        orientation="[[item.orientation]]"
        label-rotation="[[item.labelRotation]]"
        ticks="5"
        margin="[[margin]]"
        complete-series-config="[[completeSeriesConfig]]"
        prevent-series-bar
        current-domain="[[currentDomainY]]"
        domain-changed="[[domainChanged]]"
        label-position="inline"
        axis-color="grey4"
        drawn-tick-values="{{drawnTickValues}}"
        >
        </px-vis-axis>
      </template>
      <px-vis-radial-gridlines
        id="gridlines"
        svg="[[_gridSvg]]"
        axis="[[y]]"
        domain-changed="[[domainChanged]]"
        margin="[[margin]]"
        tick-values="[[drawnTickValues]]"
      >
      </px-vis-radial-gridlines>
      <template is="dom-if" if="{{showTooltip}}">
        <px-vis-tooltip
          id="tooltip"
          force-date-time-display
          tooltip-data="[[tooltipData]]"
          chart-data="[[chartData]]"
          muted-series="[[mutedSeries]]"
          x-axis-type="linear"
          y-axis-type="linear"
          complete-series-config="[[completeSeriesConfig]]"
          hover-target="[[tooltipTarget]]"
          tooltip-style="light">
        </px-vis-tooltip>
      </template>
      
      
    </div>

  </template>
</dom-module>

<script>
  Polymer({

    is: 'px-vis-polar', 
    behaviors: [
      PxVisBehaviorD3.svg,
      PxVisBehaviorD3.axes,
      PxVisBehaviorD3.selectedDomain,
      PxVisBehaviorD3.clipPath,
      PxVisBehavior.dataset,
      PxVisBehavior.mutedSeries,
      PxVisBehavior.sizing,
      PxVisBehavior.tooltipData,
      PxVisBehavior.extentsData,
      PxVisBehavior.axisTypes,
      PxVisBehavior.events,
      PxVisBehavior.completeSeriesConfig,
      PxVisBehaviorChart.chartCommon,
      Polymer.IronResizableBehavior,
      PxVisBehaviorChart.saveImage,
      PxVisBehaviorChart.subConfiguration,
      PxVisBehaviorD3.domainUpdate,
      PxVisBehaviorChart.polarData,
      PxVisBehaviorChart.timeFiltering,
    ],
    /**
    * Properties block, expose attribute values to the DOM via 'notify'
    *
    * @property properties
    * @type Object
    */
    properties: {
      /**
       * diameter of the chart drawing
       */
      diameter: {
        type: Number,
        computed: '_computeDiameter(height, width, margin)'
      },
      /**
       * radius of the chart drawing
       */
      _radius: {
        type: Number,
        computed: '_computeRadius(diameter)'
      },
      /**
       * configuration for the 4 axis and how to draw them/their labels
       */
      _axisConfigArray: {
        type: Array,
        computed: '_computeAxisConfig(diameter, counterClockwise, y, axisLabels)'
      },
      /**
       * whether the polar data should be interepreted clockwise or counter-clockwise
       */
      counterClockwise: {
        type: Boolean,
        value: false
      },
      /**
       * used for the radial scale
       */
      amplitudeKey: {
        type: String,
        computed: '_computeAmplitudeKey(completeSeriesConfig)'
      },
      /**
       * center of the chart
       */
      _center: {
        type: Array,
        computed: '_computeCenter(_radius)'
      },
      /**
       * Returned tick values from the axis
       *
       */
      drawnTickValues: {
        type: Array,
        notify: true
      },
      /**
       * Labels to be used for axis. Provide them sorted clockwise, 
       * the chart will reorder them if needed.
       * default [0,90,180,270]
       */
      axisLabels: {
        type: Array,
        value: function () {
          return ['0°','90°','180°','270°'];
        }
      },
      /**
       *
       * Allows to show the tooltip
       */
      showTooltip: {
        type: Boolean,
        value: false
      },
      /**
       * svg object used for the gridlines
       */
      _gridSvg: {
        type: Object
      },
      /**
       * svg object used fro drawing lines and markers
       */
      _drawingSvg: {
        type: Object
      },
      /**
       * <g> element used to draw the clockwise/counter clockwise label
       */
      _clockwiseLabelGroup: {
        type: Object
      },
      /**
       * <g> element used to draw the unit label
       */
      _unitLabelGroup: {
        type: Object
      }
    },
    listeners: {
     'iron-resize': '_onIronResize',
     'px-vis-scatter-request-tooltip': '_onTooltipRequest',
     'px-vis-svg-updated': '_svgReady'
    },
    observers: [
      '_drawUnitLabel(svg, completeSeriesConfig.*, _radius)',
      '_drawClockwiseLabel(svg, _radius, counterClockwise)'
    ],
    ready: function() {
      //set defaults if they have not been set
      if(!this.defaultSeriesConfig.markerScale) {
        this.defaultSeriesConfig.markerScale = '0.75';
      }
      if(!this.defaultSeriesConfig.markerFillOpacity) {
        this.defaultSeriesConfig.markerFillOpacity = '0.5';
      }
      if(!this.defaultSeriesConfig.markerStrokeOpacity) {
        this.defaultSeriesConfig.markerStrokeOpacity = '0';
      }
      if(!this.defaultSeriesConfig.xAxisUnit) {
        this.defaultSeriesConfig.xAxisUnit = '°';
      }
    },
 
    _onIronResize: function() {
      if(!this.preventResize) {
        this.debounce('ironresize', function() {
          var wrapperRect = this.$.wrapper.getBoundingClientRect();
          this.set('width', wrapperRect.width);
          this.set('height', wrapperRect.height);
        },50);
      }
    },
    _onTooltipRequest: function(evt) {
      if(this.showTooltip) {
        if(evt.detail.show) {
          this.$$('px-vis-tooltip').mousePosition = evt.detail.mouseCoords;
          this.$$('px-vis-tooltip').tooltipElem._show();
        } else {
          this.$$('px-vis-tooltip').tooltipElem._hide();
        }
      }
    },
    _computeDiameter: function(height, width, margin) {
      return Math.min(this.height - Number(this.margin.top) - Number(this.margin.bottom) ,
                      this.width - Number(this.margin.left) - Number(this.margin.right));
    },
    _computeRadius: function(diameter) {
      return diameter/2 - 35;
    },
    _adjustArrayForCounterclockwise: function(arr) {
      var result = [];
      result[0] = arr[0];
      result[1] = arr[3];
      result[2] = arr[2];
      result[3] = arr[1];
      return result;
    },
    _computeAxisConfig: function(diameter, counterClockwise, y, axisLabels) {

      var angles = [0,90,180,270],
          anchors = ['middle', 'start', 'middle', 'end'],
          result = [],
          axisLength = y.range()[1] - y.range()[0],
          labelToGrid = 10,
          halfLabelHeight = 5,
          tickRectHalfWidth = 6,
          labels = axisLabels;

      //if counter clockwise adjust various values
      if(this.counterClockwise) {
        angles = this._adjustArrayForCounterclockwise(angles);
        labels = this._adjustArrayForCounterclockwise(labels);
      }

      //build 4 config objects, one for each axis
      for( var i=0; i<4; i++) {
        var config = {},
            titleLoc = {};
        config.title = labels[i];
        config.rotation = -angles[i] + 180;
        config.orientation = 'custom';
        config.height = axisLength;
        config.labelRotation = !this.counterClockwise ? 180 + (i * 90) % 360 : (180) - i * 90;

        titleLoc.x = Number(Math.cos((i-1) * Math.PI/2) * (axisLength + labelToGrid + tickRectHalfWidth));
        titleLoc.y = halfLabelHeight + Number(Math.sin((i-1) * Math.PI/2) * (axisLength + labelToGrid + halfLabelHeight + tickRectHalfWidth));

        titleLoc.r = 0;
        //might have to adjust that?
        titleLoc.anchor = anchors[i];
        config.titleLocation = titleLoc;

        result.push(config);
      } 

      return result;
    },
    _computeAmplitudeKey: function(completeSeriesConfig) {

      var serieName = Object.keys(completeSeriesConfig)[0];
      return [completeSeriesConfig[serieName].y];
    },
    _computeCenter: function(radius) {
      return [this.diameter/2 + Number(this.margin.left),this.diameter/2 + Number(this.margin.top)];
    },
    _svgReady: function(evt) {

      var svg = evt.detail.data;
      if(!this._gridSvg) {
        //create svgs
        this.cloneSVGElem(svg.node(), '_gridSvg', true);
        this.cloneSVGElem(svg.node(), '_drawingSvg', false);

      } else {
        //keep svg attributes in sync
        var attrs = svg.node().attributes,
            grid = this._gridSvg.node(),
            drawing = this._drawingSvg.node();

        for(var i=0; i<attrs.length; i++) {
          grid.attributes[attrs[i].nodeName].nodeValue = attrs[i].nodeValue;
          drawing.attributes[attrs[i].nodeName].nodeValue = attrs[i].nodeValue;
        }
      }
    },
    _drawUnitLabel: function(svg, completeSeriesConfig, _radius) {

      //fetch unit from first config...
      var seriesId = Object.keys(this.completeSeriesConfig),
          unit = this.completeSeriesConfig[seriesId[0]].yAxisUnit,
          angle = Math.PI/4,
          length = this._radius + 10;

      //create the svg if needed
      if(!this._unitLabelGroup) {
        this.set('_unitLabelGroup', this.svg.append('g').attr('class','unit-group'));
        this._unitLabelGroup.append('text');
      }

      //make sure text is up to date
      this._unitLabelGroup.selectAll('text')
            .text(unit)
            .attr('font-size', '15px')
            .style('font-family','GE Inspira Sans')
            .attr('fill', this.colors['grey4']);

      //place label
      this._unitLabelGroup.attr('transform','translate(' + (Math.cos(angle) * length) + 
              ',' + (-Math.sin(angle) * length) + ')');
    },
    _drawClockwiseLabel: function(svg, _radius, counterClockwise) {

      //fetch unit from first config...
      var angle = -Math.PI/2,
          length = this._radius + 55;

      //create the svg if needed
      if(!this._clockwiseLabelGroup) {
        this.set('_clockwiseLabelGroup', this.svg.append('g').attr('class','clockwise-group'));
        this._clockwiseLabelGroup.append('text');
      }

      //make sure text is up to date
      this._clockwiseLabelGroup.selectAll('text')
            .text(!counterClockwise ? 'clockwise' : 'counter clockwise')
            .attr('font-size', '15px')
            .style('font-family','GE Inspira Sans')
            .attr('fill', this.colors['grey4'])
            .attr('text-anchor', 'middle');

      //place label
      this._clockwiseLabelGroup.attr('transform','translate(' + (Math.cos(angle) * length) + 
              ',' + (-Math.sin(angle) * length) + ')');
    }
  });
</script>
